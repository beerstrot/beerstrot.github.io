function makeInterface_(t){mkCall("POST",{action:"days",data:"--"},e=>{makeInterface(t,e.dates)},e=>{showMessage(messageError)})}function modifyReservation(t){mkCall("POST",{action:"getReservation",data:t},e=>{$("#ttitle").text("Modica la Prenotazione"),$("<p/>").text('La prenotazione viene modificata solo quando clicchi il pulsante "Modifica Prenotazione"').insertAfter("#ttitle"),$("#prenota").text("Modifica Prenotazione");var e=e.booking,t=e.booking_customer,o=JSON.parse(e.notes),a=new Date(e.booked_for);window.bbb=e;const n=moment(a).format("DD/MM/Y");setInterval(()=>$("#from").datetimepicker("setOptions",{value:n}),1e3),$("#quantity").prop("disabled",!1).val(e.people),updateShifts(a,e.shift_id,e.people),$("#obs").val("--"===o.note?"":o.note),$("#seggiolini").val(o.seggiolini),$("#cani").prop("checked",o.cani),$("#name").val(t.first_name),$("#surname").val(t.last_name),$("#email").val(o.email),$("#telephone").val(o.telephone)},e=>{showMessage(messageError+`
        La ID della prenotazione è: ${t}.`)})}$(document).ready(()=>{const e=new URL(window.location.href),t=e.searchParams.get("id");var o;if(t)return"notes"===t?showNotes():"days"===t?showDays():"test"===t?testeLambda():t.endsWith("_modifica")?(makeInterface_(o=t.split("_modifica")[0]),modifyReservation(o)):showReservation(t);makeInterface_()});const url="https://6nw3zi6sbkph6dledhd4op3mvq0aaduw.lambda-url.eu-central-1.on.aws/";function mkCall(e,t,o,a,n,i){if(!["POST","GET"].includes(e))return console.log("this ajax method is not good: "+e);const s={crossDomain:!0,url:url,type:e,data:t,success:o,error:a,beforeSend:()=>$("#loading").show(),complete:()=>$("#loading").hide()};"POST"===e&&(s.data=JSON.stringify(s.data),"entry"===url.split("/").reverse()[0]&&(s.contentType="application/json; charset=utf-8")),$.ajax(s)}function testeLambdaPOST(){mkCall("POST",{action:"test",data:{hey:"man",nums:[5,6,7],jac:{33:44,l:["asd","ewq",66]}}},e=>console.log("POST success:",e),e=>console.log("POST error:",e))}function testeLambdaGET(){mkCall("GET",{action:"test",data:"a get arg"},e=>console.log("GET success:",e),e=>console.log("GET error:",e))}function testeLambda(){testeLambdaGET(),testeLambdaPOST()}function showDays(e){$(".form").hide(),$("#notesTable").hide(),$("#notesDiv").show().css("margin-bottom","50%"),$("#innerNotesDiv").css("margin-top","30%"),$("#ttitle").text("BB Giorni di Chiusura AA"),mkCall("POST",{action:"days",data:e||"--"},e=>{const t=e;$("#innerNotesDiv").html("<b>Giorni chiusi ACC:</b><br>"+t.dates.join("<br>")),jQuery("#from2").datetimepicker({minDate:0,timepicker:!1,onSelectDate:(e,t)=>{showDays(e.toISOString())}}).datetimepicker("show"),$(".xdsoft_today_button").hide()},e=>{showMessage(messageError)})}function showNotes(u){$(".form").hide(),$("#notesDiv").show(),$("#innerNotesDiv").show(),$(".clearme").remove(),mkCall("GET",{action:"notes",data:u=u||(new Date).toISOString()},e=>{const t=JSON.parse(e),o=new Date(t.date).toLocaleString("it-IT",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),s=(window.nnn=t,{}),r=(t.rooms.forEach(e=>{e.tables.forEach(e=>{s[e.id]=e.name})}),window.ttt=s,t.shifts.reduce((e,t)=>(e[t.id]=t,e[t.id].bookings=[],e[t.id].obookings=[],e),{})),a=(r.anon={name:"anon",bookings:[]},window.sss=r,jQuery("#from2").datetimepicker({value:new Date(t.date),startDate:new Date(t.date),format:"d/M/Y",timepicker:!1,onSelectDate:(e,t)=>{showNotes(e.toISOString())}}),t.bookings);e=a.length;if(window.bbb=a,!e)return showNotesMessage(`nessuna prenotazione trovata il <b>${o}</b>.`);let l=0,c=0;const d=[],m=[];a.forEach((t,e)=>{try{var o=JSON.parse(t.notes);if(!("seggiolini"in o))return;d.push(o),t.notes_=o,r[t.shift_id].obookings.push(t);var a=Number(o.seggiolini),n=Boolean(o.cani),i=(l+=a,c+=n,t.booking_customer);m.push({name:i.first_name+" "+i.last_name,people:t.people,table:t.tables.reduce((e,t)=>(e.push(s[t.table_id]),e),[]).join(", "),telephone:o.telephone||"",email:o.email||"",time:new Date(t.booked_for).toLocaleString("it-it",{hour:"2-digit",minute:"2-digit"}),cani:n?"SI":"",seg:0==a?"":a,note:o.note})}catch(e){if(null===t.shift_id)return r.anon.bookings.push(t);r[t.shift_id].bookings.push(t)}}),(window.ddd=m).sort((e,t)=>e.time<t.time?-1:1).forEach(e=>{var t=$("<tr/>",{class:"clearme"}).appendTo("#notesTableBody");$("<td/>").html(e.name).appendTo(t),$("<td/>").html(e.people).appendTo(t),$("<td/>").html(e.table).appendTo(t),$("<td/>").html(e.telephone).appendTo(t),$("<td/>").html(e.email).appendTo(t),$("<td/>").html(e.time).appendTo(t),$("<td/>").html(e.cani).appendTo(t).css("background",e.cani?"lightgreen":""),$("<td/>").html(e.seg).appendTo(t).css("background",e.seg?"lightblue":""),$("<td/>").html(e.note).appendTo(t)});var n,i;let p=0;for(k in r){const h=r[k];"anon"!==k&&(h.people_online=h.obookings.reduce((e,t)=>e+t.people,0),h.people_hand=h.bookings.reduce((e,t)=>e+t.people,0),n=h.people_online+h.people_hand,p+=n,0!==n&&(i=$("<tr/>",{class:"clearme"}).appendTo("#shiftsTableBody"),$("<td/>",{css:{"text-align":"center"}}).html(h.name).appendTo(i),$("<td/>",{css:{"text-align":"center"}}).html(n).appendTo(i),$("<td/>",{css:{"text-align":"center"}}).html(h.people_online).appendTo(i),$("<td/>",{css:{"text-align":"center"}}).html(h.people_hand).appendTo(i)))}r.anon.bookings.forEach(e=>{var{t,t2:o}=getBookingTimes(e,!0),a=$("<tr/>",{class:"clearme"}).appendTo("#anonTableBody");$("<td/>",{css:{"text-align":"center"}}).html(t).appendTo(a),$("<td/>",{css:{"text-align":"center"}}).html(o).appendTo(a),$("<td/>",{css:{"text-align":"center"}}).html(e.people).appendTo(a),$("<td/>",{css:{"text-align":"center"}}).html(e.tables.reduce((e,t)=>(e.push(s[t.table_id]),e),[]).join(", ")).appendTo(a),p+=e.people});e=`Ci sono <b>${e}</b> prenotazioni (<b>${d.length}</b> online) per il giorno <b>${o}</b>, di cui <b>${c}</b> con cani e <b>${l}</b> con seggioloni. Totale di <b>${p}</b> persone.`;window.see=l,$("<p/>",{class:"clearme",css:{padding:"2%"}}).html(e).prependTo("#innerNotesDiv"),0<d.length&&$("<button/>",{class:"clearme",css:{margin:"2%",padding:"2%"}}).prependTo("#innerNotesDiv").text("Invia promemoria").on("click",()=>{showConsultaMessage("Invia la promemoria per questo giorno?","giorno: "+o,()=>mkCall("POST",{action:"promemoria",data:u},e=>{showMessage("Emails sent!")},e=>{showMessage(messageError)}),()=>$("#close-modal").click(),!0)})},e=>{showMessage(messageError)})}function makeInterface(o,e){$("#infoDiv").hide(),$("#prenota").on("click",()=>{const e=$("#from").datetimepicker("getValue"),t=(e.setHours(12),{date:e.toISOString(),shiftId:$($(".aShift").filter((e,t)=>"true"==$(t).attr("bselected"))[0]).attr("bindex"),href:window.location.href,cani:$("#cani").is(":checked"),seggiolini:$("#seggiolini").val()});["name","surname","telephone","email","quantity","obs"].forEach(e=>{t[e]=$("#"+e).val()}),validateData(t)&&(o&&(t.oldID=o.split("_")[0]),mkCall("POST",{action:"mkReservation",data:t},e=>{if("noPlacesLeft"===e.reservationID2)return showMessage("Non abbiamo più posti questo giorno.");let t=window.location.href;e=(t="/"==t[t.length-1]?t:t.split("/").reverse().slice(1).reverse().join("/")+"/")+"consulta.html?id="+e.reservationID2;window.location.href=e+(o?"_modificata":"")},e=>{showMessage(messageError)}))}),jQuery("#from").datetimepicker({format:"d/M/Y",formatDate:"Y-m-d",disabledDates:e||[],minDate:0,timepicker:!1,todayDate:!1,onSelectDate:(e,t)=>{$("#loading").show(),$("#from").chosen=!0,t.chosenn=!0,updateShifts(e)}}),$(".xdsoft_today_button").hide(),$("#privacy2").on("click",()=>{showMessage("I  dati vengono utilizzati solo per gestire la prenotazione e contattarti tramite email (assicurati non finisca nella spam) in caso di problemi o chiusura inaspettata del locale (es. causa maltempo).")})}const weekdays=["Su","Mo","Tu","We","Th","Fr","Sa"];function updateShifts(n,i,s){$(".bShift").remove();const r={day:n.getDate(),month:n.getMonth(),year:n.getYear()+1900};mkCall("POST",{action:"getShifts",data:r},e=>{var t=e=>String(e).padStart(2,"0");const o=`${r.year}-${t(r.month+1)}-`+t(r.day),a=weekdays[n.getDay()];t=e.shifts.filter(e=>e.end_period>=o&&e.start_period<=o&&e.weekdays_period.includes(a));if(0===t.length)return showMessage(`Non abbiamo ancora pianificato i turni per questa data. Vi preghiamo di scegliere un'altra data o contattarci: ${telString} `+messengerString);mkQuantityOptions(mkShiftButtons(t,i),s)},e=>showMessage(messageError))}function mkShiftButtons(t,o){const n=[],i=[];return(window.sss=t).forEach((e,t)=>{var o=e.online_seats_limit-e.booked_seats_in_shift;if(o<=0)return i.push(t);for(table in e.tables)e.tables[table]>o&&delete e.tables[table];if(e.table_sizes=Object.values(e.tables),0===e.table_sizes.length)return i.push(t);const a=$("<button/>",{id:"aShift"+t,class:"small button aShift"}).text(e.name).appendTo($("<li/>",{class:"bShift"}).appendTo("#shiftGrid"));a.bcolor=a.css("background-color"),a.bindex=e.id,a.attr("bindex",e.id),a.attr("bindex2",t),n.push(a)}),i.reverse().forEach(e=>t.splice(e,1)),0===t.length&&showMessage("Siamo al completo in questo giorno. Grazie."),n.forEach(e=>{e.click(()=>{n.forEach(e=>{e.css("background",e.bcolor),e.selected=!1,e.attr("bselected",!1)}),e.css("background","darkred"),e.attr("bselected",!0)})}),o&&$($(".aShift").filter((e,t)=>$(t).attr("bindex")==o)[0]).click(),t}function showReservation(t){$("#new").hide(),$(".form").hide(),$("#prenotaDiv").show();t.endsWith("_modificata")&&($("#ttitle").text("Prenotazione modificata. Grazie"),$("#tlegend").text("Dettagli della nuova prenotazione"),t=t.split("_modifica")[0]),mkCall("POST",{action:"getReservation",data:t},e=>{if(null===e.booking)return $("#yes").hide(),$("#no").hide(),showConsultaMessage("Non abbiamo trovato questa prenotazione.",`Puoi scriverci su ${messengerString} o chiamarci allo ${telString}.`);presentReservation(e.booking)},e=>{showMessage(messageError+`
        La ID della prenotazione è: ${t}.`)})}function presentReservation(e){if(!e||"error"in e)return bookingNotFound();var t=e.booking_customer,o=JSON.parse(e.notes);const{date:a,date2:n}=getBookingTimes(e);var i=(e,t)=>$("#"+e).text(t),t=(i("name",t.first_name+" "+t.last_name),i("telephone",o.telephone),i("email",o.email),i("day",a.toLocaleString("it-IT",{weekday:"long",year:"numeric",month:"long",day:"numeric"})),i("time1",time(a)),i("time2",time(n)),i("people",e.people),i("note",o.note),o.seggiolini);i("segg",0==t?"No":t),i("dog",o.cani?"Sì":"No"),$("#modify").click(()=>{var e=new URL(window.location.href).searchParams.get("id").split("_modificata")[0]+"_modifica";window.location.href=window.location.href.split("/").reverse().slice(1).reverse().join("/")+"/index.html?id="+e});const s=e.id;$("#cancel").click(()=>{showConsultaMessage("Vuoi davvero cancellare la prenotazione?","",()=>{mkCall("POST",{action:"cancelReservation",data:s},e=>{$("#ttitle").text("Prenotazione cancellata. Grazie"),$("tlegend").text("Dettagli della prenotazione cancellata"),$("#no").click(),$("#modify").hide(),$("#cancel").hide(),$("#new").show()},e=>{showMessage(`${messageError}
              La ID della prenotazione è: ${s}.`)})},()=>{$("#close-modal").click()})})}function validateEmail(e){return e.match(/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)}function validateData(e){$(".error").attr("style","border: solid 1px #ccc"),$(".error1").hide(),$("#notification").hide();const t=[],o=[];return $("#from").val()||(t.push("Scegli il giorno."),o.push("#from")),""===e.date&&(t.push("Scegli il giorno."),o.push("#from1")),0==e.quantity&&(t.push("Inserisci il numero di persone."),o.push("#quantity1")),void 0===e.shiftId&&(t.push("Seleziona il turno."),o.push("#shiftGrid1")),""===e.name&&(t.push("Inserisci un nome."),o.push("#name1")),""===e.surname&&(t.push("Inserisci un cognome."),o.push("#surname1")),validateEmail(e.email)||(t.push("Inserisciun un indirizzo e-mail."),o.push("#email1")),""===e.telephone&&(t.push("Inserisci un numero di telefono."),o.push("#telephone1")),$("#privacy").prop("checked")||(t.push("è necessario accettare la privacy."),o.push("#privacy2")),!(0<o.length)||(o.forEach(e=>showError(e)),showMessage(t.join("<br>")),!1)}function showMessage(e){$("#modalLead").html(e),$("#myModal").foundation("reveal","open")}const telString='<a href="tel:+390718853384"><span itemprop="telephone"> 071 8853384</span></a>',messengerString='<a target="_blank" href="https://m.me/cavecchiabeerstrot"> Facebook messenger</a>',message10=`per <b>così tante persone</b>, vi preghiamo di contattarci:
${telString}
`+messengerString,messageError=`<h2>il Server non è raggiungibile</h2>
                      <p>Riprova fra qualche istante e assicurati di avere campo nel cellulare o internet funzionante da computer. Grazie.</p>
                      <li class="no-bullet">Se il problema persiste:
                        <ul class="disc">
                          <li>Scrivici su ${messengerString}</li>
                          <li>Chiamaci al numero ${telString}</li>
                        </ul>
                      </li>`;function bookingNotFound(){var e=$("#innerInfoDiv"),e=$("<fieldset/>").appendTo(e);$("<legend/>").text("Prenotazione non trovata").appendTo(e),$("<div/>").html("<p>Vi chiediamo gentilmente di contattarci.</p>").appendTo(e),$("<div/>").html(telString).appendTo(e),$("<div/>").html(messengerString).appendTo(e),$("#buttonInfoDiv").hide()}function showNotesMessage(e){console.log("notes msg",e),$("<p/>",{class:"clearme",css:{background:"orange",padding:"2%"}}).html(e).appendTo("#notesDiv"),$("#innerNotesDiv").hide()}function showConsultaMessage(e,t,o,a,n){$("#yes").on("click",o),$("#no").on("click",a),$("#modalLead").html(e),$("#modalText").html(t),$("#myModal"+(n?"2":"")).foundation("reveal","open")}function mkQuantityOptions(e,t){window.qqq={shifts:e,people:t};var o=e.reduce((e,t)=>Math.max(e,...t.table_sizes),0);$(".aquantity").remove(),[...Array(o).keys()].forEach(e=>{$("<option/>",{value:e+1,class:"aquantity"}).text(e+1).appendTo("#quantity")}),$("#quantity").prop("disabled",!1),$("#quantity").on("input",function(){const o=Number($(this).val());if(e.forEach((e,t)=>$("#aShift"+t).prop("disabled",0===e.table_sizes.filter(e=>e>=o).length)),e.reduce((e,t,o)=>e+$("#aShift"+o).prop("disabled"),0)===e.length)return showMessage(message10);$("#notification").hide()}),t&&$("#quantity").val(t)}function showError(e){$(e.replace("1","")).attr("style","border: 2px solid red")}const time=e=>e.toLocaleString("it-IT",{hour:"2-digit",minute:"2-digit"});function getBookingTimes(e,t){console.log("timemememe",e,t);const o=new Date(e.booked_for);e=new Date(o.getTime()+6e4*e.duration);return t?{t:time(o),t2:time(e)}:{date:o,date2:e}}