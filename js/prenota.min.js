function makeInterface_(t){mkCall("POST",{action:"days",data:"--"},e=>{makeInterface(t,e.dates)},e=>{showMessage(messageError)})}$(document).ready(()=>{const e=new URL(window.location.href),t=e.searchParams.get("id");var a;if(t)return"notes"===t?showNotes():"days"===t?showDays():"test"===t?testeLambda():t.endsWith("_modifica")?(makeInterface_(a=t.split("_modifica")[0]),modifyReservation(a)):showReservation(t);makeInterface_()});const loadExtra=e=>{return JSON.parse(e.extra)};function modifyReservation(t){mkCall("POST",{action:"getReservation",data:t},e=>{$("#ttitle").text("Modica la Prenotazione"),$("<p/>").text('La prenotazione viene modificata solo quando clicchi il pulsante "Modifica Prenotazione"').insertAfter("#ttitle"),$("#prenota").text("Modifica Prenotazione");var e=e.booking,t=e.booking_customer,a=loadExtra(e),o=new Date(e.booked_for);moment(o).format("DD/MM/Y");jQuery("#from").flatpickr().setDate(o),$("#quantity").prop("disabled",!1).val(e.people),updateShifts(o,e.shift_id,e.people),$("#obs").val("--"===a.note?"":a.note),$("#seggiolini").val(a.seggiolini),$("#cani").prop("checked",a.cani),$("#name").val(t.first_name),$("#surname").val(t.last_name),$("#email").val(a.email),$("#telephone").val(a.telephone)},e=>{showMessage(messageError+`
        La ID della prenotazione è: ${t}.`)})}const url="https://6nw3zi6sbkph6dledhd4op3mvq0aaduw.lambda-url.eu-central-1.on.aws/";let pCount=0;function mkCall(e,t,a,o,i,n){if(!["POST","GET"].includes(e))return console.log("this ajax method is not good: "+e);const r={crossDomain:!0,url:url,type:e,data:t,success:a,error:o,beforeSend:()=>{pCount++,$("#loading").show()},complete:()=>{0==--pCount&&$("#loading").hide()}};"POST"===e&&(r.data=JSON.stringify(r.data),"entry"===url.split("/").reverse()[0]&&(r.contentType="application/json; charset=utf-8")),$.ajax(r)}function testeLambdaPOST(){mkCall("POST",{action:"test",data:{hey:"man",nums:[5,6,7],jac:{33:44,l:["asd","ewq",66]}}},e=>console.log("POST success:",e),e=>console.log("POST error:",e))}function testeLambdaGET(){mkCall("GET",{action:"test",data:"a get arg"},e=>console.log("GET success:",e),e=>console.log("GET error:",e))}function testeLambda(){testeLambdaGET(),testeLambdaPOST()}function showDays(e){$(".form").hide(),$("#notesTable").hide(),$("#notesDiv").show().css("margin-bottom","50%"),$("#innerNotesDiv").css("margin-top","30%"),$("#ttitle").text("Giorni di Chiusura"),$("#yes").text("Aggiungi/rimuovi giorno"),$("#no").text("Non aggiungere/rimuovere giorno"),mkCall("POST",{action:"days",data:e||"--"},e=>{const t=e;$("#innerNotesDiv").html("<b>Giorni di chiusura:</b><br>"+t.dates.join("<br>")),jQuery("#from2").flatpickr({minDate:"today",locale:"it",dateFormat:"d/M/Y",disableMobile:!0,onChange:(e,t)=>{e[0].setHours(12),toggleDate(e[0])}})},e=>{showMessage(messageError)})}function toggleDate(e){showConsultaMessage(`Sei sicuro di voler aggiungere o rimovere <b>${new Date(e).toLocaleString("it-IT",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}</b> come giorno di chiusura? `,`Se aggiungi il giorno di chiusura, tutte le prenotazione per questo giorno saranno cancellate.<br>I clienti prenotati riceveranno l'email di chiusura e cancellazione della prenotazione.<br>Se vuoi, fai un controllo dei clienti prenotati a quuesto link <a href="https://www.beerstrot.it/dashboard/" target="_blank">dashboard</a>.`,()=>{showDays(e.toISOString()),$("#close-modal").click()},()=>$("#close-modal").click(),!0)}function showNotes(h){$("#loading").show(),$(".form").hide(),$("#notesDiv").show(),$("#innerNotesDiv").show(),$(".clearme").remove(),mkCall("GET",{action:"notes",data:h=h||(new Date).toISOString()},e=>{const t=JSON.parse(e),a=new Date(t.date).toLocaleString("it-IT",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),r={},s=(t.rooms.forEach(e=>{e.tables.forEach(e=>{r[e.id]=e.name})}),t.shifts.reduce((e,t)=>(e[t.id]=t,e[t.id].bookings=[],e[t.id].obookings=[],e),{})),o=(s.anon={name:"anon",bookings:[]},jQuery("#from2").flatpickr({locale:"it",dateFormat:"d/M/Y",disableMobile:!0,onChange:(e,t)=>{e[0].setHours(12),showNotes(e[0].toISOString())}}),t.bookings);e=o.length;if(!e)return showNotesMessage(`nessuna prenotazione trovata il <b>${a}</b>.`);let l=0,c=0;const d=[],m=[];o.forEach((t,e)=>{try{var a=loadExtra(t);if(!("seggiolini"in a))return;d.push(a),t.notes_=a,s[t.shift_id].obookings.push(t);var o=Number(a.seggiolini),i=Boolean(a.cani),n=(l+=o,c+=i,t.booking_customer);m.push({name:n.first_name+" "+n.last_name,people:t.people,table:t.tables.reduce((e,t)=>(e.push(r[t.table_id]),e),[]).join(", "),telephone:a.telephone||"",email:a.email||"",time:new Date(t.booked_for).toLocaleString("it-it",{hour:"2-digit",minute:"2-digit"}),cani:i?"SI":"",seg:0==o?"":o,note:a.note})}catch(e){if(null===t.shift_id)return s.anon.bookings.push(t);s[t.shift_id].bookings.push(t)}}),m.sort((e,t)=>e.time<t.time?-1:1).forEach(e=>{var t=$("<tr/>",{class:"clearme"}).appendTo("#notesTableBody");$("<td/>").html(e.name).appendTo(t),$("<td/>",{css:{"text-align":"right"}}).html(e.people).appendTo(t),$("<td/>").html(e.table).appendTo(t),$("<td/>").html(e.telephone).appendTo(t),$("<td/>").html(e.email).appendTo(t),$("<td/>",{css:{"text-align":"left"}}).html(e.time).appendTo(t),$("<td/>").html(e.cani).appendTo(t),$("<td/>",{css:{"text-align":"right"}}).html(e.seg).appendTo(t),$("<td/>").html(e.note).appendTo(t)});var i,n;let p=0;for(k in s){const u=s[k];"anon"!==k&&(u.people_online=u.obookings.reduce((e,t)=>e+t.people,0),u.people_hand=u.bookings.reduce((e,t)=>e+t.people,0),i=u.people_online+u.people_hand,p+=i,0!==i&&(n=$("<tr/>",{class:"clearme"}).appendTo("#shiftsTableBody"),$("<td/>",{css:{"text-align":"left"}}).html(u.name).appendTo(n),$("<td/>",{css:{"text-align":"right"}}).html(i).appendTo(n),$("<td/>",{css:{"text-align":"right"}}).html(u.people_online).appendTo(n),$("<td/>",{css:{"text-align":"right"}}).html(u.people_hand).appendTo(n)))}s.anon.bookings.forEach(e=>{var{t,t2:a}=getBookingTimes(e,!0),o=$("<tr/>",{class:"clearme"}).appendTo("#anonTableBody");$("<td/>",{css:{"text-align":"left"}}).html(t).appendTo(o),$("<td/>",{css:{"text-align":"left"}}).html(a).appendTo(o),$("<td/>",{css:{"text-align":"right"}}).html(e.people).appendTo(o),$("<td/>",{css:{"text-align":"left"}}).html(e.tables.reduce((e,t)=>(e.push(r[t.table_id]),e),[]).join(", ")).appendTo(o),p+=e.people});e=`<ul class="no-bullet"><b>${a}</b> ci sono:<li><b>${e}</b> prenotazioni (<b>${d.length}</b> online)</li><li><b>${p}</b> persone prenotate</li><li><b>${c}</b> prenotazioni con cani</li><li><b>${l}</b> seggioloni richiesti</li></ul>`;$("<p/>",{class:"clearme",css:{padding:""}}).html(e).prependTo("#innerNotesDiv"),0<d.length&&$("<button/>",{class:"clearme small",css:{marginBottom:"2rem",marginTop:"2rem"}}).prependTo("#innerNotesDiv").text("Invia email di promemoria a clienti").off("click").on("click",()=>{showConsultaMessage("Vuoi inviare email di promemoria della prenotazione ai clienti?","giorno: "+a,()=>mkCall("POST",{action:"promemoria",data:h},e=>{showMessage("Email inviate")},e=>{showMessage(messageError)}),()=>$("#close-modal").click(),!0)})},e=>{showMessage(messageError)})}function makeInterface(a,e){$("#infoDiv").hide(),$("#prenota").off("click").on("click",()=>{const e=o.selectedDates[0],t=(e.setHours(12),{date:e.toISOString(),shiftId:$($(".aShift").filter((e,t)=>"true"==$(t).attr("bselected"))[0]).attr("bindex"),href:window.location.href,cani:$("#cani").is(":checked"),seggiolini:$("#seggiolini").val()});["name","surname","telephone","email","quantity","obs"].forEach(e=>{t[e]=$("#"+e).val()}),validateData(t,i).then(e=>{e&&(a&&(t.oldID=a.split("_")[0]),mkCall("POST",{action:"mkReservation",data:t},e=>{if("noPlacesLeft"===e.reservationID2)return showMessage("Questo giorno non abbiamo più posto.");let t=window.location.href;e=(t="/"==t[t.length-1]?t:t.split("/").reverse().slice(1).reverse().join("/")+"/")+"consulta.html?id="+e.reservationID2;window.location.href=e+(a?"_modificata":"")},e=>{showMessage(messageError)}))})});const o=jQuery("#from").flatpickr({locale:"it",minDate:"today",dateFormat:"Y-m-d",disable:e||[],disableMobile:!0,onChange:(e,t)=>{$("#loading").show(),$("#from").chosen=!0,t.chosenn=!0,o.close(),e[0].setHours(12),updateShifts(e[0])}}),i=(o.set("dateFormat","d/M/Y"),$("#privacy2").on("click",()=>{showMessage("I dati vengono utilizzati solo per gestire la prenotazione e contattarti tramite email (assicurati non finisca nella spam) o telefono in caso di problemi o chiusura inaspettata del locale (ad esempio causa maltempo).")}),new JustValidate("#form").addField("#name",[{rule:"required",errorMessage:"inserisci un nome"}]).addField("#surname",[{rule:"required",errorMessage:"inserisci un cognome"}]).addField("#telephone",[{rule:"required",errorMessage:"inserisci un telefono"}]).addField("#from",[{rule:"required",errorMessage:"scegli una data"}]).addField("#quantity",[{rule:"required",errorMessage:"scegli il numero di persone"}]).addField("#privacy",[{rule:"required",errorMessage:"è necessario accettare la privacy"}]).addField("#shiftGridL",[{rule:"required",errorMessage:"seleziona il turno.",validator:()=>{return void 0!==$($(".aShift").filter((e,t)=>"true"==$(t).attr("bselected"))[0]).attr("bindex")}}]).addField("#email",[{rule:"required",errorMessage:"inserisci un'e-mail"},{rule:"email",errorMessage:"L'e-mail non è valida!"}]))}const weekdays=["Su","Mo","Tu","We","Th","Fr","Sa"];function updateShifts(i,n,r){$(".bShift").remove();const s={day:i.getDate(),month:i.getMonth(),year:i.getYear()+1900};mkCall("POST",{action:"getShifts",data:s},e=>{var t=e=>String(e).padStart(2,"0");const a=`${s.year}-${t(s.month+1)}-`+t(s.day),o=weekdays[i.getDay()];t=e.shifts.filter(e=>e.end_period>=a&&e.start_period<=a&&e.weekdays_period.includes(o));if(0===t.length)return showMessage("Nei mesi da Settembre a Maggio siamo aperti dal Giovedì alla Domenica.<br>Per richieste potete contattarci tramite "+messengerString);mkQuantityOptions(mkShiftButtons(t,n),r)},e=>showMessage(messageError))}function mkShiftButtons(t,a){const i=[],n=[];return t.forEach((e,t)=>{var a=e.online_seats_limit-e.booked_seats_in_shift;if(a<=0)return n.push(t);for(table in e.tables)e.tables[table]>a&&delete e.tables[table];if(e.table_sizes=Object.values(e.tables),0===e.table_sizes.length)return n.push(t);const o=$("<a/>",{id:"aShift"+t,class:"small button aShift"}).text(e.name).appendTo($("<li/>",{class:"bShift"}).appendTo("#shiftGrid"));o.bcolor=o.css("background-color"),o.attr("bindex",e.id),i.push(o)}),n.reverse().forEach(e=>t.splice(e,1)),0===t.length&&showMessage("In questa data siamo al completo."),i.forEach(e=>{e.click(()=>{i.forEach(e=>{e.attr("bselected",!1),"none"!==e.css("pointer-events")&&e.css("background",e.bcolor)}),e.css("background","darkred"),e.attr("bselected",!0)})}),a&&$($(".aShift").filter((e,t)=>$(t).attr("bindex")==a)[0]).click(),t}function showReservation(t){$("#new").hide(),$(".form").hide(),$("#prenotaDiv").show();t.endsWith("_modificata")&&($("#ttitle").text("Prenotazione modificata. Grazie"),$("#tlegend").text("Dettaglio prenotazione modificata "),t=t.split("_modifica")[0]),mkCall("POST",{action:"getReservation",data:t},e=>{if(null===e.booking)return $("#yes").hide(),$("#no").hide(),showConsultaMessage("Prenotazione non trovata.",`Se non hai cancellato la prenotazione in precedenza, puoi scriverci tramite ${messengerString} o chiamarci al numero ${telString} per chiarimenti.`);presentReservation(e.booking)},e=>{showMessage(messageError+`
        La ID della prenotazione è: ${t}.`)})}function presentReservation(e){if(!e||"error"in e)return bookingNotFound();var t=e.booking_customer,a=loadExtra(e);const{date:o,date2:i}=getBookingTimes(e);var n=(e,t)=>$("#"+e).text(t),t=(n("name",t.first_name+" "+t.last_name),n("telephone",a.telephone),n("email",a.email),n("day",o.toLocaleString("it-IT",{weekday:"long",year:"numeric",month:"long",day:"numeric"})),n("time1",time(o)),n("time2",time(i)),n("people",e.people),n("note",a.note),a.seggiolini);n("segg",0==t?"No":t),n("dog",a.cani?"Sì":"No"),$("#modify").click(()=>{var e=new URL(window.location.href).searchParams.get("id").split("_modificata")[0]+"_modifica";window.location.href=window.location.href.split("/").reverse().slice(1).reverse().join("/")+"/index.html?id="+e});const r=e.id;$("#cancel").click(()=>{showConsultaMessage("Vuoi cancellare la prenotazione?","",()=>{mkCall("POST",{action:"cancelReservation",data:r},e=>{$("#ttitle").text("Prenotazione cancellata. Grazie"),$("tlegend").text("Dettaglio prenotazione cancellata "),$("#no").click(),$("#modify").hide(),$("#cancel").hide(),$("#new").show()},e=>{showMessage(`${messageError}
              La ID della prenotazione è: ${r}.`)})},()=>{$("#close-modal").click()})})}function validateEmail(e){return e.match(/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)}function validateData(t,e){return e.revalidate().then(()=>{const e=[];return $("#from").val()||e.push("#from"),""===t.date&&e.push("#from1"),0==t.quantity&&e.push("#quantity1"),void 0===t.shiftId&&e.push("#shiftGrid1"),""===t.name&&e.push("#name1"),""===t.surname&&e.push("#surname1"),validateEmail(t.email)||e.push("#email1"),""===t.telephone&&e.push("#telephone1"),$("#privacy").prop("checked")||e.push("#privacy3"),!(0<e.length)||(e.forEach(e=>showError(e)),!1)})}function showMessage(e){$("#modalLead").html(e),$("#myModal").foundation("reveal","open")}const telString='<a href="tel:+390718853384"><span itemprop="telephone"> 071 8853384</span></a>',messengerString='<a target="_blank" href="https://m.me/cavecchiabeerstrot"> Facebook Messenger</a>',message10=`Per <b>13 o più persone</b>, vi preghiamo di contattarci tramite ${messengerString} o telefonarci al numero `+telString,messageError=`<h2>il Server non è raggiungibile</h2><p>Riprova fra qualche istante e assicurati di avere campo nel cellulare o internet funzionante da computer. Grazie.</p><li class="no-bullet">Se il problema persiste:<ul class="disc"><li>Scrivici su ${messengerString}</li><li>Chiamaci al numero ${telString}</li></ul></li>`;function bookingNotFound(){var e=$("#innerInfoDiv"),e=$("<fieldset/>").appendTo(e);$("<legend/>").text("Prenotazione non trovata").appendTo(e),$("<div/>").html("<p>Vi chiediamo gentilmente di contattarci.</p>").appendTo(e),$("<div/>").html(telString).appendTo(e),$("<div/>").html(messengerString).appendTo(e),$("#buttonInfoDiv").hide()}function showNotesMessage(e){$("<p/>",{class:"clearme",css:{background:"orange",padding:"2%"}}).html(e).appendTo("#notesDiv"),$("#innerNotesDiv").hide()}function showConsultaMessage(e,t,a,o,i){$("#yes").off("click").on("click",a),$("#no").off("click").on("click",o),$("#modalLead2").html(e),$("#modalText").html(t),$("#myModal"+(i?"2":"")).foundation("reveal","open")}function mkQuantityOptions(e,t){var a=e.reduce((e,t)=>Math.max(e,...t.table_sizes),0);$(".aquantity").remove(),[...Array(a).keys()].forEach(e=>{$("<option/>",{value:e+1,class:"aquantity"}).text(e+1).appendTo("#quantity")}),$("#quantity").prop("disabled",!1);const o={"pointer-events":"",cursor:"pointer",background:"#ce2f24"},i={"pointer-events":"none",cursor:"default",background:"#ce9f94"};$("#quantity").off("input").on("input",function(){const a=Number($(this).val());if(e.forEach((e,t)=>{e=0===e.table_sizes.filter(e=>e>=a).length?i:o;$("#aShift"+t).css(e).attr("bselected",!1)}),e.reduce((e,t,a)=>{return e+("none"===$("#aShift"+a).css("pointer-events"))},0)===e.length)return showMessage(message10);$("#notification").hide()}),t&&$("#quantity").val(t)}function showError(e){$(e.replace("1","")).attr("style","border: 2px solid red !important")}const time=e=>e.toLocaleString("it-IT",{hour:"2-digit",minute:"2-digit"});function getBookingTimes(e,t){const a=new Date(e.booked_for);e=new Date(a.getTime()+6e4*e.duration);return t?{t:time(a),t2:time(e)}:{date:a,date2:e}}