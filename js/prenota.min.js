function makeInterface_(a){mkCall("POST",{action:"days",data:"--"},e=>{makeInterface(a,e.dates)},e=>{showMessage(messageError)})}function modifyReservation(a){mkCall("POST",{action:"getReservation",data:a},e=>{var e=e.booking,a=e.booking_customer,t=JSON.parse(e.notes),o=new Date(e.booked_for),i=moment(o).format("DD/MMM/Y");$("#from").datetimepicker("setOptions",{value:i}),$("#quantity").prop("disabled",!1).val(e.people),updateShifts(o,e.shift_id,e.people),$("#obs").val("--"===t.note?"":t.note),$("#seggiolini").val(t.seggiolini),$("#cani").prop("checked",t.cani),$("#name").val(a.first_name),$("#surname").val(a.last_name),$("#email").val(t.email),$("#telephone").val(t.telephone)},e=>{showMessage(messageError+`
        La ID della prenotazione è: ${a}.`)})}$(document).ready(()=>{const e=new URL(window.location.href),a=e.searchParams.get("id");var t;if(a)return"notes"===a?showNotes():"days"===a?showDays():"test"===a?testeLambda():a.endsWith("_modifica")?(makeInterface_(t=a.split("_modifica")[0]),modifyReservation(t)):showReservation(a);makeInterface_()});const url="https://6nw3zi6sbkph6dledhd4op3mvq0aaduw.lambda-url.eu-central-1.on.aws/";function mkCall(e,a,t,o,i,n){if(!["POST","GET"].includes(e))return console.log("this ajax method is not good: "+e);const s={crossDomain:!0,url:url,type:e,data:a,success:t,error:o,beforeSend:()=>$("#loading").show(),complete:()=>$("#loading").hide()};"POST"===e&&(s.data=JSON.stringify(s.data),"entry"===url.split("/").reverse()[0]&&(s.contentType="application/json; charset=utf-8")),$.ajax(s)}function testeLambdaPOST(){mkCall("POST",{action:"test",data:{hey:"man",nums:[5,6,7],jac:{33:44,l:["asd","ewq",66]}}},e=>console.log("POST success:",e),e=>console.log("POST error:",e))}function testeLambdaGET(){mkCall("GET",{action:"test",data:"a get arg"},e=>console.log("GET success:",e),e=>console.log("GET error:",e))}function testeLambda(){testeLambdaGET(),testeLambdaPOST()}function showDays(e){$(".form").hide(),$("#notesTable").hide(),$("#notesDiv").show().css("margin-bottom","50%"),$("#innerNotesDiv").css("margin-top","30%"),$("#ttitle").text("Giorni di Chiusura"),mkCall("POST",{action:"days",data:e||"--"},e=>{const a=e;$("#innerNotesDiv").html("<b>Giorni chiusi:</b><br>"+a.dates.join("<br>")),jQuery("#from2").datetimepicker({minDate:0,timepicker:!1,inline:!0,onSelectDate:(e,a)=>{showDays(e.toISOString())}}).datetimepicker("show")},e=>{showMessage(messageError)})}function showNotes(o){$(".form").hide(),$("#notesDiv").show(),$("#innerNotesDiv").show(),$(".clearme").remove(),mkCall("GET",{action:"notes",data:o=o||"2022-07-04T09:40:41.729Z"},e=>{var e=JSON.parse(e),a=new Date(e.date).toLocaleString("it-IT",{weekday:"long",year:"numeric",month:"long",day:"numeric"});jQuery("#from2").datetimepicker({startDate:new Date(e.date),format:"d/M/Y",timepicker:!1,inline:!0,onSelectDate:(e,a)=>{showNotes(e.toISOString())}}).datetimepicker("show");const t=e.bookings;e=t.length;if(!e)return showNotesMessage(`nessuna prenotazione trovata il <b>${a}</b>.`);let r=0,l=0;const c=[];t.forEach((e,a)=>{try{var t=JSON.parse(e.notes);if(!("seggiolini"in t))return;c.push(t);var o,i,n=t.seggiolini,s=Boolean(t.cani);r+=n,l+=s,(n||s)&&(o=$("<tr/>",{class:"clearme",css:{background:a%2==0?"#fff":"#ddd"}}).appendTo("#notesTableBody"),i=e.booking_customer,$("<td/>").html(i.first_name+" "+i.last_name).appendTo(o),$("<td/>").html(t.telephone||"").appendTo(o),$("<td/>").html(t.email||"").appendTo(o),$("<td/>").html(new Date(e.booked_for).toLocaleString("it-IT",{hour:"2-digit",minute:"2-digit"})).appendTo(o),$("<td/>",{css:{background:s?"rgba(200, 255, 200, 0.5)":""}}).html(s?"X":"").appendTo(o),$("<td/>",{css:{background:0==n?"":"rgba(200, 200, 255, 0.5)"}}).html(0==n?"":n).appendTo(o),$("<td/>").html(t.note).appendTo(o))}catch(e){console.log("ok")}});e=`Ci sono <b>${e}</b> prenotazioni (${c.length} online) per il giorno <b>${a}</b>, di cui <b>${l}</b> con cani e <b>${r}</b> con seggiolini.`;if(r+l===0)return showNotesMessage(e);$("<p/>",{class:"clearme",css:{padding:"2%"}}).html(e).prependTo("#innerNotesDiv"),0<c.length&&$("<button/>",{class:"clearme",css:{margin:"2%",padding:"2%"}}).prependTo("#innerNotesDiv").text("Invia promemoria").on("click",()=>{mkCall("POST",{action:"promemoria",data:o},e=>{showMessage("Emails sent!")},e=>{showMessage(messageError)})})},e=>{showMessage(messageError)})}function makeInterface(o,e){$("#infoDiv").hide(),$("#prenota").on("click",()=>{const e=$("#from").datetimepicker("getValue"),a=(e.setHours(12),{date:e.toISOString(),shiftId:$($(".aShift").filter((e,a)=>"true"==$(a).attr("bselected"))[0]).attr("bindex"),href:window.location.href,cani:$("#cani").is(":checked"),seggiolini:$("#seggiolini").val()});["name","surname","telephone","email","quantity","obs"].forEach(e=>{a[e]=$("#"+e).val()}),validateData(a)&&mkCall("POST",{action:"mkReservation",data:a},e=>{if("noPlacesLeft"===e.reservationID2)return showMessage("Non abbiamo più posti questo giorno.");let a=window.location.href;const t=(a="/"==a[a.length-1]?a:a.split("/").reverse().slice(1).reverse().join("/")+"/")+"consulta.html?id="+e.reservationID2;o?mkCall("POST",{action:"cancelReservation",data:o},e=>{window.location.href=t},e=>{showMessage(messageError+`
                La ID della prenotazione è: ${o}.`)}):window.location.href=t},e=>{showMessage(messageError)})}),jQuery("#from").datetimepicker({lang:"it",format:"d/M/Y",formatDate:"Y-m-d",disabledDates:e||[],minDate:0,timepicker:!1,onSelectDate:(e,a)=>{$("#loading").show(),$("#from").chosen=!0,a.chosenn=!0,updateShifts(e)}}),$("#privacy2").on("click",()=>{showMessage("I  dati vengono utilizzati solo per gestire la prenotazione e contattarti tramite email (assicurati non finisca nella spam) in caso di problemi o chiusura inaspettata del locale (es. causa maltempo).")})}const weekdays=["Su","Mo","Tu","We","Th","Fr","Sa"];function updateShifts(i,n,s){$(".bShift").remove();const r={day:i.getDate(),month:i.getMonth(),year:i.getYear()+1900};mkCall("POST",{action:"getShifts",data:r},e=>{var a=e=>String(e).padStart(2,"0");const t=`${r.year}-${a(r.month+1)}-`+a(r.day),o=weekdays[i.getDay()];mkQuantityOptions(mkShiftButtons(e.shifts.filter(e=>e.end_period>=t&&e.start_period<=t&&e.weekdays_period.includes(o)),n),s)},e=>showMessage(messageError))}function mkShiftButtons(e,t){const i=[];return e.forEach((e,a)=>{var t=e.online_seats_limit-e.online_booked_seats;if(!(t<=0)){for(table in e.tables)e.tables[table]>t&&delete e.tables[table];e.table_sizes=Object.values(e.tables);const o=$("<button/>",{id:"aShift"+a,class:"small button aShift"}).text(e.name).appendTo($("<li/>",{class:"bShift"}).appendTo("#shiftGrid"));o.bcolor=o.css("background-color"),o.bindex=e.id,o.attr("bindex",e.id),o.attr("bindex2",a),i.push(o)}}),i.forEach(e=>{e.click(()=>{i.forEach(e=>{e.css("background",e.bcolor),e.selected=!1,e.attr("bselected",!1)}),e.css("background","darkred"),e.attr("bselected",!0)})}),t&&$($(".aShift").filter((e,a)=>$(a).attr("bindex")==t)[0]).click(),e}function showReservation(a){$(".form").hide(),$("#prenotaDiv").show(),mkCall("POST",{action:"getReservation",data:a},e=>{if(null===e.booking)return $("#yes").hide(),$("#no").hide(),showConsultaMessage("Non abbiamo trovato questa prenotazione.",`Puoi scriverci su ${messengerString} o chiamarci allo ${telString}.`);presentReservation(e.booking)},e=>{showMessage(messageError+`
        La ID della prenotazione è: ${a}.`)})}function presentReservation(e){if(!e||"error"in e)return bookingNotFound();var a=e.booking_customer,t=JSON.parse(e.notes);const o=new Date(e.booked_for),i=new Date(o.getTime()+6e4*e.duration);var n=(e,a)=>$("#"+e).text(a),a=(n("name",a.first_name+" "+a.last_name),n("telephone",t.telephone),n("email",t.email),n("day",o.toLocaleString("it-IT",{weekday:"long",year:"numeric",month:"long",day:"numeric"})),n("time1",o.toLocaleString("it-IT",{hour:"2-digit",minute:"2-digit"})),n("time2",i.toLocaleString("it-IT",{hour:"2-digit",minute:"2-digit"})),n("people",e.people),n("note",t.note),t.seggiolini);n("segg",0==a?"No":a),n("dog",t.cani?"Sì":"No"),$("#modify").click(()=>{showConsultaMessage("Vuoi modificare la prenotazione?","(NOTA: La prenotazione rimane la stessa fino a quando non viene premuto il tasta Modifica.)",()=>{var e=new URL(window.location.href).searchParams.get("id")+"_modifica";window.location.href=window.location.href.split("/").reverse().slice(1).reverse().join("/")+"/index.html?id="+e},()=>$("#close-modal").click())});const s=e.id;$("#cancel").click(()=>{showConsultaMessage("Cancella la prenotazione?","",()=>{mkCall("POST",{action:"cancelReservation",data:s},e=>{$("<li/>").appendTo("#infoList").html("<b>Status</b>: cancelled").css("background","pink"),$("#no").click(),$("#modify").hide(),$("#cancel").hide()},e=>{showMessage(`${messageError}
              La ID della prenotazione è: ${s}.`)})},()=>$("#close-modal").click())})}function validateEmail(e){return e.match(/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)}function validateData(e){$(".error").attr("style","border: solid 1px #ccc"),$(".error1").hide(),$("#notification").hide();const a=[],t=[];return $("#from").val()||(a.push("Scegli il giorno."),t.push("#from")),""===e.date&&(a.push("Scegli il giorno."),t.push("#from1")),0==e.quantity&&(a.push("Inserisci il numero di persone."),t.push("#quantity1")),void 0===e.shiftId&&(a.push("Seleziona il turno."),t.push("#shiftGrid1")),""===e.name&&(a.push("Inserisci un nome."),t.push("#name1")),""===e.surname&&(a.push("Inserisci un cognome."),t.push("#surname1")),validateEmail(e.email)||(a.push("Inserisciun un indirizzo e-mail."),t.push("#email1")),""===e.telephone&&(a.push("Inserisci un numero di telefono."),t.push("#telephone1")),$("#privacy").prop("checked")||(a.push("è necessario accettare la privacy."),t.push("#privacy2")),!(0<t.length)||(t.forEach(e=>showError(e)),showMessage(a.join("<br>")),!1)}function showMessage(e){$("#modalLead").html(e),$("#myModal").foundation("reveal","open")}const telString='<a href="tel:+390718853384"><span itemprop="telephone"> 071 8853384</span></a>',messengerString='<a target="_blank" href="https://m.me/cavecchiabeerstrot"> Facebook messenger</a>',message10=`per <b>così tante persone</b>, vi preghiamo di contattarci:
${telString}
`+messengerString,messageError=`<h2>il Server non è raggiungibile</h2>
                      <p>Riprova fra qualche istante e assicurati di avere campo nel cellulare o internet funzionante da computer. Grazie.</p>
                      <li class="no-bullet">Se il problema persiste:
                        <ul class="disc">
                          <li>Scrivici su ${messengerString}</li>
                          <li>Chiamaci al numero ${telString}</li>
                        </ul>
                      </li>`;function bookingNotFound(){var e=$("#innerInfoDiv"),e=$("<fieldset/>").appendTo(e);$("<legend/>").text("Prenotazione non trovata").appendTo(e),$("<div/>").html("<p>Vi chiediamo gentilmente di contattarci.</p>").appendTo(e),$("<div/>").html(telString).appendTo(e),$("<div/>").html(messengerString).appendTo(e),$("#buttonInfoDiv").hide()}function showNotesMessage(e){$("<p/>",{class:"clearme",css:{background:"orange",padding:"2%"}}).html(e).appendTo("#notesDiv"),$("#innerNotesDiv").hide()}function showConsultaMessage(e,a,t,o){$("#yes").on("click",t),$("#no").on("click",o),$("#modalLead").html(e),$("#modalText").html(a),$("#myModal").foundation("reveal","open")}function mkQuantityOptions(e,a){var t=e.reduce((e,a)=>Math.max(e,...a.table_sizes),0);$(".aquantity").remove(),[...Array(t).keys()].forEach(e=>{$("<option/>",{value:e+1,class:"aquantity"}).text(e+1).appendTo("#quantity")}),$("#quantity").prop("disabled",!1),$("#quantity").on("input",function(){const t=Number($(this).val());if(e.forEach((e,a)=>$("#aShift"+a).prop("disabled",0===e.table_sizes.filter(e=>e>=t).length)),e.reduce((e,a,t)=>e+$("#aShift"+t).prop("disabled"),0)===e.length)return showMessage(message10);$("#notification").hide()}),a&&$("#quantity").val(a)}function showError(e){$(e.replace("1","")).attr("style","border: 2px solid red")}